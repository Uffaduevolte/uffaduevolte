<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Tuner</title>
    <style>
        /* ... (stili esistenti) ... */
    </style>
</head>
<body>
    <h1>Voice Tuner</h1>
    <p id="freqDisplay">Hz</p>
    <p id="noteDisplay" class="red">Nota: --</p>
    <div id="intensityBar"><div id="intensityLevel"></div></div>
    <div id="pentagramma">
        <div class="stave" id="treble-stave">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
        </div>
        <div class="grey-line"></div>
        <div class="stave" id="bass-stave">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
        </div>
        <div class="note" id="red-dot" style="top: 60px; left: 150px;"></div>
    </div>
    <script>
        const noteFrequencies = {
            /* ... (frequenze esistenti) ... */
        };

        const notePositions = {
            /* ... (posizioni note esistenti) ... */
        };

        let lastNote = null; // Memorizza l'ultima nota rilevata

        async function startPitchDetection() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioContext = new AudioContext();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 2048;
            const buffer = new Float32Array(analyser.fftSize);

            function detectPitch() {
                analyser.getFloatTimeDomainData(buffer);
                let maxVal = 0, sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    maxVal = Math.max(maxVal, Math.abs(buffer[i]));
                    sum += buffer[i] * buffer[i];
                }
                const intensity = Math.sqrt(sum / buffer.length);
                document.getElementById("intensityLevel").style.width = `${intensity * 100}%`;

                let fundamentalFreq = autoCorrelate(buffer, audioContext.sampleRate);

                if (fundamentalFreq > 0 && intensity > 0.01) {
                    document.getElementById("freqDisplay").innerText = `${fundamentalFreq.toFixed(2)} Hz`;
                    let closestNote = Object.entries(noteFrequencies).reduce((prev, curr) =>
                        Math.abs(curr[1] - fundamentalFreq) < Math.abs(prev[1] - fundamentalFreq) ? curr : prev);
                    document.getElementById("noteDisplay").innerText = `Nota: ${closestNote[0]}`;
                    document.getElementById("noteDisplay").className =
                        Math.abs(closestNote[1] - fundamentalFreq) < 1 ? "green" : "red";

                    const note = closestNote[0];
                    document.getElementById("red-dot").style.top = `${notePositions[note] || 60}px`;
                    lastNote = note; // Aggiorna l'ultima nota rilevata
                } else if (lastNote) {
                    document.getElementById("noteDisplay").innerText = `Nota: ${lastNote}`;
                } else {
                    document.getElementById("freqDisplay").innerText = `Hz`;
                    document.getElementById("noteDisplay").innerText = `--`;
                    document.getElementById("noteDisplay").className = "red";
                }
                setTimeout(detectPitch, 250); // Update pitch every 250 ms
            }
            detectPitch();
        }

        function autoCorrelate(buffer, sampleRate) {
            let bestOffset = -1, bestCorrelation = 0;
            for (let offset = 2; offset < buffer.length / 2; offset++) {
                let correlation = 0;
                for (let i = 0; i < buffer.length / 2; i++) {
                    correlation += buffer[i] * buffer[i + offset];
                }
                if (correlation > bestCorrelation) {
                    bestCorrelation = correlation;
                    bestOffset = offset;
                }
            }
            return bestOffset > 0 ? sampleRate / bestOffset : -1;
        }

        startPitchDetection();
    </script>
    <img id="immagine-sfondo" src="images/MiaFaccia001.jpg" alt="Sfondo">
    <div id="my-channel">
        <a href="https://youtube.com/@marcellomazzotti?si=ujMxAi8PYidn_zSA" target="_blank">My Channel</a>
    </div>
</body>
</html>
