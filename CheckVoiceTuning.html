<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voice Tuner</title>
    <style>
        /* (Stili invariati) */
    </style>
</head>
<body>
    <h1>Voice Tuner</h1>
    <p id="freqDisplay">Hz</p>
    <p id="noteDisplay" class="red">Nota: --</p>
    <div id="intensityBar"><div id="intensityLevel"></div></div>
    <div id="pentagramma">
        <div class="stave" id="treble-stave">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
        </div>
        <div class="grey-line"></div>
        <div class="stave" id="bass-stave">
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
            <div class="line"></div>
        </div>
        <div class="note" id="red-dot" style="top: 60px; left: 150px;"></div>
    </div>
    <script>
        const noteFrequencies = {
            /* (Dati invariati) */
        };

        const notePositions = {
            /* (Dati invariati) */
        };

        async function startPitchDetection() {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            const audioContext = new AudioContext();
            const analyser = audioContext.createAnalyser();
            const microphone = audioContext.createMediaStreamSource(stream);
            microphone.connect(analyser);
            analyser.fftSize = 2048;
            const buffer = new Float32Array(analyser.fftSize);

            function detectPitch() {
                analyser.getFloatTimeDomainData(buffer);
                let maxVal = 0, sum = 0;
                for (let i = 0; i < buffer.length; i++) {
                    maxVal = Math.max(maxVal, Math.abs(buffer[i]));
                    sum += buffer[i] * buffer[i];
                }
                const intensity = Math.sqrt(sum / buffer.length);
                document.getElementById("intensityLevel").style.width = `${intensity * 100}%`;

                let fundamentalFreq = autoCorrelate(buffer, audioContext.sampleRate);
                if (fundamentalFreq > 0 && intensity > 0.01) {
                    document.getElementById("freqDisplay").innerText = `${fundamentalFreq.toFixed(2)} Hz`;
                    let closestNote = Object.entries(noteFrequencies).reduce((prev, curr) =>
                        Math.abs(curr[1] - fundamentalFreq) < Math.abs(prev[1] - fundamentalFreq) ? curr : prev);
                    document.getElementById("noteDisplay").innerText = `Nota: ${closestNote[0]}`;
                    document.getElementById("noteDisplay").className =
                        Math.abs(closestNote[1] - fundamentalFreq) < 1 ? "green" : "red";

                    const note = closestNote[0];
                    document.getElementById("red-dot").style.top = `${notePositions[note] || 60}px`;
                } else {
                    document.getElementById("freqDisplay").innerText = `Frequenza: -- Hz`;
                    document.getElementById("noteDisplay").innerText = `Nota: --`;
                    document.getElementById("noteDisplay").className = "red";
                }
                setTimeout(detectPitch, 250); // Aggiorna il pitch ogni 250 ms
            }
            detectPitch();
        }

        function autoCorrelate(buffer, sampleRate) {
            let SIZE = buffer.length;
            let MAX_SAMPLES = Math.floor(SIZE / 2);
            let bestOffset = -1;
            let bestCorrelation = 0;
            let rms = 0;
            let foundGoodCorrelation = false;
            let correlations = new Array(MAX_SAMPLES);

            for (let i = 0; i < SIZE; i++) {
                let val = buffer[i];
                rms += val * val;
            }
            rms = Math.sqrt(rms / SIZE);
            if (rms < 0.01) return -1;

            let lastCorrelation = 1;
            for (let offset = 0; offset < MAX_SAMPLES; offset++) {
                let correlation = 0;

                for (let i = 0; i < MAX_SAMPLES; i++) {
                    correlation += Math.abs((buffer[i]) - (buffer[i + offset]));
                }
                correlation = 1 - (correlation / MAX_SAMPLES);
                correlations[offset] = correlation;
                if ((correlation > 0.9) && (correlation > lastCorrelation)) {
                    foundGoodCorrelation = true;
                    if (correlation > bestCorrelation) {
                        bestCorrelation = correlation;
                        bestOffset = offset;
                    }
                } else if (foundGoodCorrelation) {
                    let shift = (correlations[bestOffset + 1] - correlations[bestOffset - 1]) / correlations[bestOffset];  
                    let frequency = sampleRate / (bestOffset + (8 * shift));
                    return correctOctave(frequency);
                }
                lastCorrelation = correlation;
            }
            if (bestCorrelation > 0.01) {
                let frequency = sampleRate / bestOffset;
                return correctOctave(frequency);
            }
            return -1;
        }

        function correctOctave(frequency) {
            while (frequency < 16.35) frequency *= 2;
            while (frequency > 987.77) frequency /= 2;
            return frequency;
        }

        startPitchDetection();
    </script>
    <img id="immagine-sfondo" src="images/MiaFaccia001.jpg" alt="Sfondo">
    <div id="my-channel">
        <a href="https://youtube.com/playlist?list=PLFsPt7w5CeuzdK7t2GE93wnO6iOgR2NRj&si=37oDtrgcJ1SX-fAP" target="_blank">My Channel</a>
    </div>
</body>
</html>
