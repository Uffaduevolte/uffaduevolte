<style>
    .note {
        position: absolute;
        width: 20px; /* Modificato per corrispondere allo spazio tra le righe */
        height: 20px; /* Modificato per corrispondere allo spazio tra le righe */
        background-color: red;
        border-radius: 50%;
    }
</style>

<script>
    function autoCorrelate(buffer, sampleRate) {
        let bestOffset = -1, bestCorrelation = 0, rms = 0;
        const SIZE = buffer.length;
        const MAX_SAMPLES = Math.floor(SIZE / 2);
        const MIN_SAMPLES = 0;

        for (let i = 0; i < SIZE; i++) {
            let val = buffer[i];
            rms += val * val;
        }
        rms = Math.sqrt(rms / SIZE);
        if (rms < 0.01) return -1;

        let lastCorrelation = 1;
        for (let offset = MIN_SAMPLES; offset < MAX_SAMPLES; offset++) {
            let correlation = 0;

            for (let i = 0; i < MAX_SAMPLES; i++) {
                correlation += Math.abs((buffer[i]) - (buffer[i + offset]));
            }
            correlation = 1 - (correlation / MAX_SAMPLES);
            if (correlation > lastCorrelation) {
                bestCorrelation = correlation;
                bestOffset = offset;
            }
            lastCorrelation = correlation;
        }
        if (bestCorrelation > 0.01) {
            return sampleRate / bestOffset;
        }
        return -1;
    }

    function detectPitch() {
        analyser.getFloatTimeDomainData(buffer);
        let maxVal = 0, sum = 0;
        for (let i = 0; i < buffer.length; i++) {
            maxVal = Math.max(maxVal, Math.abs(buffer[i]));
            sum += buffer[i] * buffer[i];
        }
        const intensity = Math.sqrt(sum / buffer.length);
        document.getElementById("intensityLevel").style.width = `${intensity * 100}%`;

        let fundamentalFreq = autoCorrelate(buffer, audioContext.sampleRate);
        if (fundamentalFreq > 0 && intensity > 0.01) {
            document.getElementById("freqDisplay").innerText = `${fundamentalFreq.toFixed(2)} Hz`;
            let closestNote = Object.entries(noteFrequencies).reduce((prev, curr) =>
                Math.abs(curr[1] - fundamentalFreq) < Math.abs(prev[1] - fundamentalFreq) ? curr : prev);
            document.getElementById("noteDisplay").innerText = `Nota: ${closestNote[0]}`;
            document.getElementById("noteDisplay").className =
                Math.abs(closestNote[1] - fundamentalFreq) < 1 ? "green" : "red";

            const note = closestNote[0];
            document.getElementById("red-dot").style.top = `${notePositions[note] || 60}px`;
        } else {
            document.getElementById("freqDisplay").innerText = `Frequenza: -- Hz`;
            document.getElementById("noteDisplay").innerText = `Nota: --`;
            document.getElementById("noteDisplay").className = "red";
        }
        setTimeout(detectPitch, 250); // Aggiorna il pitch ogni 250 ms
    }
</script>
